---
title: '"Acceptabiliy Analysis for Catalan and Spanish Ratings"'
author: "ASSASSMG"
date: "`r Sys.Date()`"
output: html_document
---

```{r, setup, include=FALSE}
# The following line sets the [working directory](https://bookdown.org/yihui/rmarkdown-cookbook/working-directory.html) for reading in the files. 
# Exchange the part before `/CaSpaSyn/code` with wherever you have the copy of the repository.
knitr::opts_knit$set(root.dir = "~/repos/CaSpaSyn/code/")

# Don't include warnings and messages in the rendered document.
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r packages, include=FALSE}
# Load/install libraries. 
#install.packages("tidyverse")
packages <- c("tidyverse", "lubridate", "gridExtra", "car", "namer")

installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
	install.packages(packages[!installed_packages])
}

invisible(lapply(packages, library, character.only = TRUE))
```

# Data Exploration

```{r loadData}
# Load data.
df.cat.initial <- read_csv("../data/Catalan_ASSASSMG.csv")
df.spa.initial <- read_csv("../data/Spanish_ASSASSMG.csv")

# Print data overview.
str(df.cat.initial, give.attr = FALSE, give.length = FALSE, vec.len = 3, max.level = 3, digits.d = 3)
str(df.spa.initial, give.attr = FALSE, give.length = FALSE, vec.len = 3, max.level = 3, digits.d = 3)
```

```{r dataTreatment, include = FALSE}
# Make sure that the ratings are treated as numerical data, not strings. 
df.cat <- transform(df.cat.initial, Rating = as.numeric(Rating))
df.spa <- transform(df.spa.initial, Rating = as.numeric(Rating))
```

## Overall Rating Distribution

Ratings are very skewed towards the high end of the scale.

```{r ratingBoxplot, echo=FALSE}
box.spa <- ggplot(df.spa, aes(x=Rating)) +
    geom_histogram(binwidth=.5, na.rm = TRUE,
                   colour="black", fill="white") + 
    scale_x_continuous(n.breaks=7) + # display all x axis ticks
    ggtitle("Castilian Ratings")

box.cat <- ggplot(df.cat, aes(x=Rating)) +
    geom_histogram(binwidth=.5, na.rm = TRUE,
                   colour="black", fill="white") + 
    scale_x_continuous(n.breaks=7) + # display all x axis ticks 
    ggtitle("Catalan Ratings")

grid.arrange(box.spa, box.cat, ncol=2)
#ggsave(filename = "../figures/rating_count_distribution.png")
```

```{r normalityAllRatings, echo=FALSE}
shapiro.test(df.cat$Rating)
shapiro.test(df.spa$Rating)
```

## Outlier Inspection

### Participants

Plots of rating distribution per participant.

#### Catalan

```{r catRatingDist, figures-side, fig.show="hold", out.width="50%", echo = FALSE}
for (i in c(unique(df.cat$Code))) {
  subset(df.cat, Code %in% c(unique(df.cat$Code)))
  temp <- subset(df.cat, Code == i)

  name <- paste("Rating distribution of participant", i, sep = " ")
  
  print(ggplot(temp, aes(x=Rating)) +
    geom_histogram(binwidth=.5, na.rm = TRUE,
                   colour="black", fill="white") + 
    scale_x_continuous(n.breaks=7) + # display all x axis ticks 
    ggtitle(name))
  
  temp <- transform(temp, Rating = as.numeric(Rating))
}
```

#### Castilian

```{r spaRatingDist, fig.show="hold", out.width="50%", echo = FALSE}
for (i in c(unique(df.spa$Code))) {
  subset(df.cat, Code %in% c(unique(df.spa$Code)))
  temp <- subset(df.spa, Code == i)

  name <- paste("Rating distribution of participant", i, sep = " ")
  
  print(ggplot(temp, aes(x=Rating)) +
    geom_histogram(binwidth=.5, na.rm = TRUE,
                   colour="black", fill="white") + 
    scale_x_continuous(n.breaks=7) +# display all x axis ticks 
    ggtitle(name))
}
```

### Survey Completion Time

Check for completion times 1 standard deviation away from average survey completion time ([source](https://academic.oup.com/poq/article/72/5/914/1832496#28138951)).

```{r surveytime, results = "hide", echo = FALSE}
# Make new column with duration in minutes for Catalan and Castilian
df.cat <- df.cat %>%
mutate(surveyduration = minute(seconds_to_period(End - Start)))
df.spa <- df.spa %>%
mutate(surveyduration = minute(seconds_to_period(End - Start)))

# Subset df for participants
subjTimes.cat <- df.cat %>% distinct(Code, .keep_all = T) 
subjTimes.spa <- df.spa %>% distinct(Code, .keep_all = T) 

# Plot
times.cat <- ggplot(subjTimes.cat, aes(x=surveyduration)) +
    geom_histogram(binwidth=.5, na.rm = TRUE,
                   colour="black", fill="white") + 
    scale_x_continuous(n.breaks=23) +# display all x axis ticks 
    ggtitle("Survey durations Catalan")

times.spa <- ggplot(subjTimes.spa, aes(x=surveyduration)) +
    geom_histogram(binwidth=.5, na.rm = TRUE,
                   colour="black", fill="white") + 
    scale_x_continuous(n.breaks=23) +# display all x axis ticks 
    ggtitle("Survey durations Castilian")

grid.arrange(times.spa, times.cat, ncol=2)
#ggsave(filename = "../figures/surveydurations.png")

# Find exclusion criteria, usually 1 SD away from the mean, 1.5 sd in brackets
round(mean(df.cat$surveyduration) + 1.5 *sd(df.cat$surveyduration), 0) # 17 (19)
round(mean(df.cat$surveyduration) - 1.5 *sd(df.cat$surveyduration), 0) # 10 (8)

round(mean(df.spa$surveyduration) + 1.5 *sd(df.spa$surveyduration), 0) # 19 (21)
round(mean(df.spa$surveyduration) - 1.5 *sd(df.spa$surveyduration), 0) # 8 (6)
```

The strong filter (1 SD from the mean) would exclude over half of the participants, the lax filter (1.5 SD from the mean) much less. 

```{r exclusionTimes, results="hide"}
nrow(subjTimes.cat %>% filter(surveyduration < 10 | surveyduration > 17)) # 14 out of 25
nrow(subjTimes.cat %>% filter(surveyduration < 8 | surveyduration > 19)) # 2 out of 25

nrow(subjTimes.spa %>% filter(surveyduration < 8 | surveyduration > 9)) # 21 out of 26
nrow(subjTimes.spa %>% filter(surveyduration < 6 | surveyduration > 21)) # 3 out of 26
```


### Rating Development over Time

Check whether participants used more extreme ratings towards the end of the study. Split (experimental) items in two groups: 50%:50% and 45%:15% and compare rating distribution. Extreme deviation from the rest of the split may lead to exclusion fo the participants.

```{r}
# code here
```

# Comparing Castilian and Catalan verbs in regards to dativ usage

Test for normal distribution of the ratings using the Shapiro-Wilk normality test (comes with base R).

```{r}
# shapiro.test(df$COLUMNNAME)
```

Use non-parametric tests after we show that most of the data is not normally distributed For a given verb, compare the active and pronominal usage using: - **variance** of the ratings with the Levene test - **means** of the ratings using man Mann-Whitney test

Compare the Variance.

```{r}
#leveneTest(abhängige Variable ~ Gruppierungsvariable, data = df)
```

Compare the Means. (Heißt Wilcox, mach aber Mann-Whitney) If the p-value is below 0.05 there is a significat difference between the two groups. The function `tapply` prints the mean of the two groups, which is not done by the `wilcox` function.

```{r}
#wilcox.test(df$abhängige Variable ~ df$Gruppierungsvariable)
#tapply(df$group1,df$group2,mean)
```

# Comparison between Castilian and Catalan Cognates

AA&AI vs. PA&PI, AA&PA vs. AI&PI, PN? (vs. PA oder PI)

...same as above once the code works.

```{r}
# code here
```

# Animacy Comparison

...same as above once the code works.

```{r}
# code here
```
